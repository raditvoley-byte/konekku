<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Catur Online Firebase</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  background:#0f172a;
  color:white;
  font-family:Arial;
  display:flex;
  flex-direction:column;
  align-items:center;
}
h2{margin:10px}

#menu{
  margin:10px;
}
input,button{
  padding:8px;
  margin:4px;
  border:none;
  border-radius:6px;
}
button{
  background:#2563eb;
  color:white;
  cursor:pointer;
}
button:hover{opacity:.8}

#status{
  margin:6px;
  font-size:14px;
  opacity:.9;
}

#board{
  width:320px;
  height:320px;
  display:grid;
  grid-template-columns:repeat(8,1fr);
  border:4px solid #fff;
}

.square{
  width:40px;
  height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:26px;
  cursor:pointer;
  user-select:none;
}
.light{background:#e5e7eb}
.dark{background:#4ade80}

.selected{
  outline:3px solid red;
}
.turn{
  color:#22c55e;
}
</style>
</head>

<body>

<h2>♟️ Catur Online</h2>

<div id="menu">
  <input id="room" placeholder="Kode Room">
  <button onclick="buatRoom()">Buat Room</button>
  <button onclick="gabungRoom()">Gabung</button>
</div>

<div id="status">Belum terhubung</div>
<div id="board"></div>

<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot }
from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDdD92BTyFSd2xcouL6G9h92SNha99C7dY",
  authDomain: "konekku-e391f.firebaseapp.com",
  projectId: "konekku-e391f",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= GAME ================= */
const boardEl = document.getElementById("board");
const statusEl = document.getElementById("status");

let roomRef;
let warna = "";
let state = null;
let selected = null;

const ikon = {
  r:"♜", n:"♞", b:"♝", q:"♛", k:"♚", p:"♟",
  R:"♖", N:"♘", B:"♗", Q:"♕", K:"♔", P:"♙"
};

function papanAwal(){
  return [
    "rnbqkbnr",
    "pppppppp",
    "........",
    "........",
    "........",
    "........",
    "PPPPPPPP",
    "RNBQKBNR"
  ];
}

function render(){
  boardEl.innerHTML="";
  state.board.forEach((row,y)=>{
    [...row].forEach((p,x)=>{
      const d=document.createElement("div");
      d.className="square "+((x+y)%2?"dark":"light");
      if(selected && selected.x===x && selected.y===y){
        d.classList.add("selected");
      }
      d.textContent=ikon[p]||"";
      d.onclick=()=>klik(x,y);
      boardEl.appendChild(d);
    });
  });

  statusEl.innerHTML = `
    Room: <b>${state.room}</b> |
    Kamu: <b>${warna}</b> |
    Giliran: <span class="turn">${state.turn}</span>
  `;
}

function milikKita(p){
  return warna==="white" ? p===p.toUpperCase() : p===p.toLowerCase();
}

function klik(x,y){
  if(state.turn!==warna) return;

  const p = state.board[y][x];
  if(selected){
    jalan(selected.x,selected.y,x,y);
    selected=null;
  }else if(p!=="." && milikKita(p)){
    selected={x,y};
  }
}

async function jalan(x1,y1,x2,y2){
  let b = state.board.map(r=>r.split(""));
  b[y2][x2]=b[y1][x1];
  b[y1][x1]=".";
  state.board=b.map(r=>r.join(""));
  state.turn = state.turn==="white"?"black":"white";
  await updateDoc(roomRef,state);
}

/* ================= ROOM ================= */
window.buatRoom = async ()=>{
  const id=Math.random().toString(36).substr(2,6);
  roomRef=doc(db,"chess",id);
  await setDoc(roomRef,{
    room:id,
    board:papanAwal(),
    turn:"white",
    players:1
  });
  warna="white";
  listen();
};

window.gabungRoom = async ()=>{
  const id=document.getElementById("room").value;
  roomRef=doc(db,"chess",id);
  const snap=await getDoc(roomRef);
  if(!snap.exists()) return alert("Room tidak ada");
  warna="black";
  await updateDoc(roomRef,{players:2});
  listen();
};

function listen(){
  onSnapshot(roomRef,(snap)=>{
    state=snap.data();
    render();
  });
}
</script>

</body>
</html>
